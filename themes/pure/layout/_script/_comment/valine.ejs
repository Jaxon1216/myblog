<% if (typeof(script) !== 'undefined' && script) { %>
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@3.15.0/dist/av-min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = '<%= theme.comment.valine.meta %>';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  // Prefer server-rendered canonical key if available; fallback to normalized path
  var pagePath = window.__VALINE_KEY__ || (function(){
    var p = window.location.pathname.replace(/index\.html$/, '/');
    if (!/\/$/.test(p)) p += '/';
    return p;
  })();
  new Valine({
    el: '#vcomments',
    verify: <%= theme.comment.valine.verify %>,
    notify: <%= theme.comment.valine.notify %>,
    appId: '<%= theme.comment.valine.appid %>',
    appKey: '<%= theme.comment.valine.appkey %>',
    <% if (theme.comment.valine.serverURLs) { %>
    serverURLs: '<%= theme.comment.valine.serverURLs %>',
    <% } %>
    placeholder: '<%= theme.comment.valine.placeholder %>',
    avatar: '<%= theme.comment.valine.avatar %>',
    meta: meta,
    pageSize: '<%= theme.comment.valine.pageSize %>' || 10,
    visitor: <%= theme.comment.valine.visitor %>,
    path: pagePath
  });
  </script>
<% } %>
